From 753e7ca7f338bc3adcedc3b6e6bd420ee8bff3f9 Mon Sep 17 00:00:00 2001
From: Luiz Capitulino <lcapitulino@redhat.com>
Date: Mon, 21 Feb 2011 19:50:12 -0300
Subject: [PATCH 13/13] Fix CVE-2011-0011 qemu-kvm: Setting VNC password to empty string silently disables all authentication

RH-Author: Luiz Capitulino <lcapitulino@redhat.com>
Message-id: <20110221165012.063c79b1@doriath>
Patchwork-id: 18608
O-Subject: [PATCH 6.0.z qemu-kvm] Fix CVE-2011-0011 qemu-kvm: Setting VNC
	password to empty string silently disables all authentication
Bugzilla: 668598
RH-Acked-by: Juan Quintela <quintela@redhat.com>
RH-Acked-by: Daniel P. Berrange <berrange@redhat.com>
RH-Acked-by: Zachary Amsden <zamsden@redhat.com>
RH-Acked-by: Alex Williamson <alex.williamson@redhat.com>

This is the z-stream backport of rhel6.1 commit 24505953, which is
a backport of upstream commit 1cd20f8b.

Because of spice bits in the same function, the rhel6.1's fix doesn't
apply cleanly in the rhel6.0 branch. Thus a new patch is needed.

Signed-off-by: Luiz Capitulino <lcapitulino@redhat.com>
---

IMPORTANT: Please, review with care. Besides the spice specific bits, the
upstream commit does some cleanup I don't fully understand, but I'm
assuming we backported the needed bits in rhel6.1.

BZ: 668598

 vnc.c |    5 -----
 1 files changed, 0 insertions(+), 5 deletions(-)

Signed-off-by: Luiz Capitulino <lcapitulino@redhat.com>
---
 vnc.c |    5 -----
 1 files changed, 0 insertions(+), 5 deletions(-)

diff --git a/vnc.c b/vnc.c
index 26acf73..5724df3 100644
--- a/vnc.c
+++ b/vnc.c
@@ -2525,16 +2525,11 @@ int vnc_display_password(DisplayState *ds, const char *password, int lifetime)
     if (password && password[0]) {
         if (!(vs->password = qemu_strdup(password)))
             return -1;
-        if (vs->auth == VNC_AUTH_NONE) {
-            vs->auth = VNC_AUTH_VNC;
-        }
         if (lifetime) {
             vs->expires = time(NULL) + lifetime;
         } else {
             vs->expires = 0;
         }
-    } else {
-        vs->auth = VNC_AUTH_NONE;
     }
 
     return 0;
-- 
1.7.4.rc1.16.gd2f15e

